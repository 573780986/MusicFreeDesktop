name: 打包
on: 
    workflow_dispatch:
jobs:
    build-windows: 
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                node-version: 20
                cache: 'npm'
            - uses: actions/setup-python@v5 # 安装 Python，解决 better-sqlite3 编译依赖
              with:
                python-version: '3.12'
            - name: 安装 Python distutils（解决 node-gyp 编译问题）
              run: pip install setuptools
            - run: echo (node -p -e '`VERSION=${require("./package.json").version}`') >> $Env:GITHUB_ENV
            - run: npm install
            - run: npm run package            
            - uses: maotoumao/inno-setup-action-cli@main
              with: 
                  filepath: ./release/build-windows.iss
                  variables: /DMyAppVersion=${{ env.VERSION }} /DMyAppId=${{ secrets.MYAPPID }}
            - name: Rename Setup File
              run: Rename-Item -Path "./out/MusicFreeSetup.exe" -NewName "MusicFree-${{ env.VERSION }}-win32-x64-setup.exe"
            - name: Upload Setup
              uses: actions/upload-artifact@v4
              with:
                  name: MusicFree-${{ env.VERSION }}-win32-x64-setup
                  path: ./out/MusicFree-${{ env.VERSION }}-win32-x64-setup.exe
            - name: Generate Portable
              run: mkdir ./out/MusicFree-win32-x64/portable
            - uses: vimtor/action-zip@v1.1
              with:
                files: ./out/MusicFree-win32-x64
                dest: MusicFree-${{ env.VERSION }}-win32-x64-portable.zip
            - name: Upload Portable
              uses: actions/upload-artifact@v4
              with:
                  name: MusicFree-${{ env.VERSION }}-win32-x64-portable
                  path: ${{ github.workspace }}/MusicFree-${{ env.VERSION }}-win32-x64-portable.zip

    build-windows-legacy: 
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                node-version: 18
                cache: 'npm'
            - uses: actions/setup-python@v5 # 安装 Python，解决 better-sqlite3 编译依赖
              with:
                python-version: '3.10' # 对应 Node 18
            - run: echo (node -p -e '`VERSION=${require("./package.json").version}`') >> $Env:GITHUB_ENV
            - run: npm install
            - name: 降级 better-sqlite3 适配 Node 18
              run: npm install better-sqlite3@8.6.0 --force
            - run: npm install electron@22
            - run: npm run package            
            - uses: maotoumao/inno-setup-action-cli@main
              with: 
                  filepath: ./release/build-windows.iss
                  variables: /DMyAppVersion=${{ env.VERSION }} /DMyAppId=${{ secrets.MYAPPID }}
            - name: Rename Setup File
              run: Rename-Item -Path "./out/MusicFreeSetup.exe" -NewName "MusicFree-${{ env.VERSION }}-win32-x64-legacy-setup.exe"
            - name: Upload Setup
              uses: actions/upload-artifact@v4
              with:
                  name: MusicFree-${{ env.VERSION }}-win32-x64-legacy-setup
                  path: ./out/MusicFree-${{ env.VERSION }}-win32-x64-legacy-setup.exe
            - name: Generate Portable
              run: mkdir ./out/MusicFree-win32-x64/portable
            - uses: vimtor/action-zip@v1.1
              with:
                files: ./out/MusicFree-win32-x64
                dest: MusicFree-${{ env.VERSION }}-win32-x64-legacy-portable.zip
            - name: Upload Portable
              uses: actions/upload-artifact@v4
              with:
                  name: MusicFree-${{ env.VERSION }}-win32-x64-legacy-portable
                  path: ${{ github.workspace }}/MusicFree-${{ env.VERSION }}-win32-x64-legacy-portable.zip

    build-macos-x64: 
        runs-on: macos-15-intel
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v4
              with:
                python-version: '3.10'
            - uses: actions/setup-node@v4
              with:
                node-version: 18
                cache: 'npm'
            - run: node -p -e '`VERSION=${require("./package.json").version}`' >> $GITHUB_ENV
            - run: npm install
            - run: npm run make            
            - run: ls ./out/make
            - name: Rename DMG File
              run: mv "./out/make/MusicFree-${{ env.VERSION }}-x64.dmg" "./out/make/MusicFree-${{ env.VERSION }}-darwin-x64.dmg"
            - name: Upload Setup
              uses: actions/upload-artifact@v4
              with:
                  name: MusicFree-${{ env.VERSION }}-darwin-x64
                  path: ./out/make/MusicFree-${{ env.VERSION }}-darwin-x64.dmg

    build-macos-arm64: 
        runs-on: macos-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v4
              with:
                python-version: '3.10'
            - uses: actions/setup-node@v4
              with:
                node-version: 18
                cache: 'npm'
            - run: node -p -e '`VERSION=${require("./package.json").version}`' >> $GITHUB_ENV
            - run: npm install            
            - run: npm run make -- --arch="arm64"
            - name: Rename DMG File
              run: mv "./out/make/MusicFree-${{ env.VERSION }}-arm64.dmg" "./out/make/MusicFree-${{ env.VERSION }}-darwin-arm64.dmg"
            - name: Upload Setup
              uses: actions/upload-artifact@v4
              with:
                  name: MusicFree-${{ env.VERSION }}-darwin-arm64
                  path: ./out/make/MusicFree-${{ env.VERSION }}-darwin-arm64.dmg

    build-ubuntu: 
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                node-version: 18
                cache: 'npm'
            - run: node -p -e '`VERSION=${require("./package.json").version}`' >> $GITHUB_ENV
            - run: npm install            
            - run: npm run make
            - name: Find and Rename DEB File
              run: |
                  DEB_FILE=$(find ./out/make/deb/x64/ -name "*.deb" | head -1)
                  if [ -n "$DEB_FILE" ]; then
                      mv "$DEB_FILE" "./out/make/deb/x64/MusicFree-${{ env.VERSION }}-linux-amd64.deb"
                  fi
            - name: Upload Setup
              uses: actions/upload-artifact@v4
              with:
                  name: MusicFree-${{ env.VERSION }}-linux-amd64
                  path: ./out/make/deb/x64/MusicFree-${{ env.VERSION }}-linux-amd64.deb

    release:
        needs: [build-windows, build-windows-legacy, build-macos-x64, build-macos-arm64, build-ubuntu]
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: 拉取项目完整代码
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ github.ref }} # 拉取当前触发分支，确保文件完整
            - name: 从 release/version.json 获取版本号和更新日志
              id: get_version_and_changelog
              run: |
                  # 定义 version.json 文件路径
                  VERSION_JSON_PATH="./release/version.json"
                  
                  # 检查文件是否存在
                  if [ ! -f "$VERSION_JSON_PATH" ]; then
                      echo "错误：未找到 $VERSION_JSON_PATH 文件"
                      exit 1
                  fi
                  
                  # 使用 Node 解析 JSON 文件，提取 version 和 changeLog
                  # 1. 提取版本号
                  VERSION=$(node -p -e 'require("./release/version.json").version')
                  # 2. 提取 changeLog 数组并拼接为格式化字符串（保留原数组中的换行和缩进）
                  CHANGELOG=$(node -p -e 'require("./release/version.json").changeLog.join("\n")')
                  
                  # 检查版本号和更新日志是否有效
                  if [ -z "$VERSION" ]; then
                      echo "错误：从 $VERSION_JSON_PATH 中未提取到有效的 version 字段"
                      exit 1
                  fi
                  
                  if [ -z "$CHANGELOG" ] || [ "$(echo "$CHANGELOG" | wc -c)" -lt 10 ]; then
                      CHANGELOG="### 未找到详细更新日志，本次为常规版本更新。"
                  fi
                  
                  # 输出到 GitHub Output（供后续步骤使用）
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "current_date=$(date +"%Y-%m-%d")" >> $GITHUB_OUTPUT
                  echo "changelog<<EOF" >> $GITHUB_OUTPUT
                  echo "$CHANGELOG" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT
            - name: 下载所有打包产物
              uses: actions/download-artifact@v4
              with:
                  path: ./all-artifacts
            - name: 发布到GitHub Releases
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ steps.get_version_and_changelog.outputs.version }} # 标签格式：v1.0.0
                  release_name: MusicFree v${{ steps.get_version_and_changelog.outputs.version }}
                  body: |
                      # MusicFree v${{ steps.get_version_and_changelog.outputs.version }}
                      发布日期：${{ steps.get_version_and_changelog.outputs.current_date }}
                      
                      ## 本次更新内容
                      ${{ steps.get_version_and_changelog.outputs.changelog }}
                      
                      ## 支持平台
                      - Windows：64位正式版（win32-x64）、64位旧版兼容版（win32-x64-legacy，支持Win7/8.1）
                      - macOS：Intel x64芯片、Apple Silicon arm64芯片（M1/M2/M3）
                      - Linux：Ubuntu 64位（amd64）
                      
                      ## 使用说明
                      1. Windows用户：双击.exe安装包安装，或解压portable绿色版直接运行
                      2. macOS用户：双击.dmg包，拖拽应用到Applications文件夹
                      3. Linux用户：使用`dpkg -i 文件名.deb`命令安装
                  files: ./all-artifacts/**/*
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}